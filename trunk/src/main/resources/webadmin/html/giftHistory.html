<!DOCTYPE html>
<html>
<head>
    <title>Store Warning</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../css/mask.css" rel="stylesheet" type="text/css"/>
    <link href="../css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="../js/jquery.1.9.js"></script>
    <!--<script src="../js/session.js"></script>-->
    <!--<script src="../js/cookie_OLD.js"></script>-->
    <script type="text/javascript" src="../js/mask.js"></script>

    <style type="text/css">
        table,th,td
        {
            border:1px solid #778899;
            padding-left:5px;
            padding-right:5px;
        }
        table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background-color: #2F4F4F;
            color:white;
            height:40px;
        }
    </style>

</head>
<body>

<div>
    <h2>Store Warn</h2>

    <div>
        Store:<input type="text" id="f_storeId">
        Committer:<input type="text" id="f_committer">
        Status:
        <select id="f_status">
            <option value="all">All</option>
            <option value="0">New</option>
            <option value="1">Reviewed</option>
        </select>
        <button id="btnFind">Find</button>
    </div>
    <hr />
    <table id="warnTable">

    </table>
    <hr />
    <div id="btnNext" style="background: #126daf; color: #eff4f8; text-align: center; cursor: pointer;">
        next
        <br/> â§©
    </div>
</div>


<script type="text/javascript">
    var glb_storeId;
    var glb_committer;
    var glb_status;
    var glb_time;
    var glb_pageSize = 40;

    function clearTable() {
        var head = "<tr>";
        head += "<th>Status</th>";
        head += "<th>Store</th>";
        head += "<th>Committer</th>";
        head += "<th>Date</th>";
        head += "<th>Message</th>";
        head +="</tr>";
        $("#warnTable").html(head);
    }

    function setRowStatus(rowName, status) {
        var color = "#ffffff";
        if(status==0) {
            color = "#fcefa1";
        }
        $("#" + rowName).css("backgroundColor", color)
    }
    function addItem(item) {
        var row;
        var date = new Date(item.date);

        var typeName = item.typeName  +  "[" + item.warningType + "]";

        var statusHtml = "<select name='rStatus' id='" + item._id +"'>";
        statusHtml += "<option value='0' " + ">New</option>";
        statusHtml += "<option value='1' " + ">Viewed</option>";
        statusHtml += "</select>"

        row = "<tr id='r_" + item._id + "'>";
        row += "<td> " +statusHtml + " </td>";
        row += "<td> " + item.storeId + " </td>";
        row += "<td> " + item.committer + " </td>";
        row += "<td> " + date.toLocaleDateString() + " </td>";
        row += "<td> " + typeName + " </td>";
        row += "</tr>";
        $("#warnTable").append(row);

        setRowStatus("r_" + item._id, item.status);
        $("#" + item._id).val(item.status);
        $("#" + item._id).on('change', function(r) {

            var url = "/service/store/warn/setStatus";
            url += "?_id=" + item._id;
            url += "&status=" + $("#" + item._id).val();
            $("#" + item._id).css('background-color', 'yellow');
            $.getJSON(url).done(function (data) {
                $("#" + item._id).css('background-color', '#e6f1f9');
                setRowStatus("r_" + item._id, $("#" + item._id).val());
            }).fail(function() {
                $("#" + item._id).css('background-color', '#ebcccc');
            });
        });
    }
    function loadPage() {
        var mUrl = "/service/store/warn/getAll?time=" + glb_time;
        if (glb_storeId)
            mUrl += "&storeId=" + glb_storeId;
        if (glb_committer)
            mUrl += "&committer=" + glb_committer;
        if (glb_status)
            mUrl += "&status=" + glb_status;
        if (glb_pageSize)
            mUrl += "&pageSize=" + glb_pageSize;
        $.getJSON(mUrl).done(function (data) {
            $.each(data, function (i, item) {
                addItem(item);
                glb_time = item.date;
            });
        });
    }
    $(document).ready(function () {
        clearTable();
        loadPage();
        $("#btnFind").click(function () {
            clearTable();
            glb_storeId = $("#f_storeId").val();
            glb_committer = $("#f_committer").val();
            glb_status = $("#f_status").val();
            glb_time = 0;
            loadPage();
        });
        $("#btnNext").click(function () {
            loadPage();
        });
    });
</script>
</body>
</html>