<!DOCTYPE html>
<html>
<head>
    <title>Store Warning</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../css/mask.css" rel="stylesheet" type="text/css"/>
    <link href="../css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="../js/jquery.1.9.js"></script>
    <!--<script src="../js/session.js"></script>-->
    <!--<script src="../js/cookie_OLD.js"></script>-->
    <script type="text/javascript" src="../js/mask.js"></script>
    <script src="../selectize/js/standalone/selectize.js"></script>
    <!--<script src="../selectize/remove_button/plugin.js"></script>-->
    <link rel="stylesheet" href="../selectize/css/selectize.default.css">
    <!--<link rel="stylesheet" href="../selectize/less/plugins/remove_button.less">-->

    <style type="text/css">
        table,th,td
        {
            border:1px solid #778899;
            padding-left:5px;
            padding-right:5px;
        }
        table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        th {
            background-color: #2F4F4F;
            color:white;
            height:40px;
        }
    </style>

</head>
<body>

<div>
    <h2>Gift Type Configuration</h2>

    <hr />
    <table id="mTable">

    </table>

    <hr />

    <table>
        <tr>
            <td>Gift Id :</td>
            <td><input type="text" id="txtGiftTypeId"/></td>
        </tr>
        <tr>
            <td>Service Id :</td>
            <td>
                <div id="serviceIdList"></div>
                <select id="selServiceId">
                </select>
            </td>
        </tr>
        <tr>
            <td>Name :</td>
            <td><input type="text" id="txtName"/></td>
        </tr>
        <tr>
            <td>Description : </td>
            <td><input type="text" id="txtDesc"/></td>
        </tr>
        <tr>
            <td>Icon :</td>
            <td><input type="text" id="txtIcon"/></td>
        </tr>
        <tr>
            <td>Image :</td>
            <!--<input type="text" id="txtImage"/>-->
            <td>
                <table>
                    <tr>
                        <td>IOS</td>
                        <td><input type="text" id="txtImageIOS"/></td>
                    </tr>
                    <tr>
                        <td>LDPI</td>
                        <td><input type="text" id="txtImageLDPI"/>
                    </tr>
                    <tr>
                        <td>MDPI</td>
                        <td><input type="text" id="txtImageMDPI"/></td>
                    </tr>
                    <tr>
                        <td>HDPI</td>
                        <td><input type="text" id="txtImageHDPI"/></td>
                    </tr>
                    <tr>
                        <td>XHDPI</td>
                        <td><input type="text" id="txtImageXHDPI"/></td>
                    </tr>
                    <tr>
                        <td>XXHDPI</td>
                        <td><input type="text" id="txtImageXXHDPI"/></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td>Transferable</td>
            <td><input type="checkbox" id="chkTransfer"/></td>
        </tr>
        <tr>
            <td>status</td>
            <td>
                <select id="selStatus">
                    <option value="1">ACTIVE</option>
                    <option value="2" selected>INACTIVE</option>
                    <option value="3">DELETED</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>isNew</td>
            <td><input type="checkbox" id="chkIsNew"/></td>
        </tr>

        <tr>
            <td>Visible</td>
            <td><input type="checkbox" id="chkVisible"/></td>
        </tr>

        <tr>
            <td>price</td>
            <td><input type="text" id="txtPrice"/></td>
        </tr>
        <tr>
            <td>Policy</td>
            <td><textarea id="txtPolicy" cols="30" rows="10"></textarea></td>
        </tr>
        <tr>
            <td></td>
            <td><button id="btnSave">Save</button></td>
        </tr>
    </table>
</div>



<script type="text/javascript">
    var serviceOption;

    var glb_storeId;
    var glb_committer;
    var glb_status;
    var glb_time;
    var glb_pageSize = 40;

    var serviceSelector;

    function addServiceId(id, name) {
    }

    function loadServiceOption() {
        $.getJSON("/service/getAvailableTranType").done(function (data) {
            $.each(data, function (i, item) {
                serviceOption += "<option value='" + item.tranTypeId + "'>" + item.tranTypeName + "</option>";
            });
            $("#selServiceId").html(serviceOption);

            var $ids = $('#selServiceId').selectize({
                maxItems: 100,
                minItems: 0,
                plugins: ['remove_button'],
                delimiter: ',',
                persist: false,
                create: function(input) {
                    return {
                        value: input,
                        text: input
                    }
                }
            });
            serviceSelector = $ids[0].selectize;
        });
    }

    function clearTable() {
        var head = "<tr>";
        head += "<th></th>";
        head += "<th>Id</th>";
        head += "<th>Service Id</th>";
        head += "<th>Name</th>";
        head += "<th>Desc</th>";
        head += "<th>Icon</th>";
        head += "<th>Image</th>";
        head += "<th>Transferable</th>";
        head += "<th>Status</th>";
        head += "<th>ModifyDate</th>";
        head += "<th>isNew</th>";
        head += "<th>Visible</th>";
        head += "<th>Price</th>";
        head +="</tr>";
        $("#mTable").html(head);
    }

    function setRowStatus(rowName, status) {
        var color = "#ffffff";
        if(status==0) {
            color = "#fcefa1";
        }
        $("#" + rowName).css("backgroundColor", color)
    }

    function imageTag(source) {
        return '<image height="60" src="' + source + '"/>';
    }

    function fillForm(item) {
        $("#txtGiftTypeId").val(item._id);

        try {
            var arr = JSON.parse(item.serviceId);
            serviceSelector.setValue(arr);
        } catch (e) {

        }

        $("#txtName").val(item.name);
        $("#txtDesc").val(item.desc);
        $("#txtIcon").val(item.icon);
//        $("#txtImage").val(item.image);
        var json = JSON.parse(item.image);

        $("#txtImageIOS").val(json.ios);
        $("#txtImageLDPI").val(json.ldpi);
        $("#txtImageMDPI").val(json.mdpi);
        $("#txtImageHDPI").val(json.hdpi);
        $("#txtImageXHDPI").val(json.xhdpi);
        $("#txtImageXXHDPI").val(json.xxhdpi);

        $("#chkTransfer").prop('checked', item.transfer);
        $("#selStatus").val(item.status);
        $("#chkIsNew").prop('checked', item.isNew);
        $("#chkVisible").prop('checked', item.visible);
        $("#txtPrice").val(item.price);
        $("#txtPolicy").val(item.policy);
    }

    function addItem(item) {
        var row;
        var date = new Date(item.modifyDate);
        var editButton = "<button id='edit_" + item._id + "'>Edit</button>";

        row = "<tr id='r_" + item._id + "'>";
        row += "<td> " + editButton + " </td>";
        row += "<td> " + item._id + " </td>";
        row += "<td> <div  style='max-width:300px;word-wrap:break-word'>" + item.serviceId + "</div></td>";

        row += "<td> " + item.name + " </td>";
        row += "<td> " + item.desc + " </td>";
        row += "<td> " + imageTag(item.icon) + " </td>";
        row += "<td> " + item.image + " </td>";
        row += "<td> " + item.transfer + " </td>";
        row += "<td> " + item.status + " </td>";
        row += "<td> " + date + " </td>";
        row += "<td> " + item.isNew + " </td>";
        row += "<td> " + item.visible + " </td>";
        row += "<td> " + item.price + " </td>";
        row += "</tr>";
        $("#mTable").append(row);
        $("#edit_" + item._id).click(function () {
            fillForm(item);
        });
    }
    function loadPage() {
        var mUrl = "/service/gift/type/getAll";
        $.getJSON(mUrl).done(function (data) {
            $.each(data, function (i, item) {
                console.log(item);
                addItem(item);
            });
        });
    }

    function getImage() {
        var json =  {
            ios: $("#txtImageIOS").val(),
            ldpi: $("#txtImageLDPI").val(),
            mdpi: $("#txtImageMDPI").val(),
            hdpi: $("#txtImageHDPI").val(),
            xhdpi: $("#txtImageXHDPI").val(),
            xxhdpi: $("#txtImageXXHDPI").val()

        }
        return JSON.stringify(json);
    }

    $(document).ready(function () {
        loadServiceOption();
        clearTable();
        loadPage();

        $("#btnSave").click(function () {

            var arr = serviceSelector.items;
            var serviceIds = [];
            var k=0;
            arr.forEach(function (i) {
                serviceIds[k++]='"' + i + '"';
            });
            console.log("" + serviceIds);
            $.ajax({
                url: "/service/gift/type/create",
                type: "POST",
                data: {
                    _id: $("#txtGiftTypeId").val(),
                    serviceId: "[" +serviceIds.toString() + "]",
                    name: $("#txtName").val(),
                    desc: $("#txtDesc").val(),
                    icon: $("#txtIcon").val(),
                    image: getImage(),
                    transfer: $("#chkTransfer").prop('checked'),
                    status: $("#selStatus").val(),
                    isNew: $("#chkIsNew").prop('checked'),
                    visible:$("#chkVisible").prop('checked'),
                    price: $("#txtPrice").val(),
                    policy: $("#txtPolicy").val()
                },
                success: function (result) {
                    var error = result.error;
                    if (error == 0) {
                        alert("Thành công.");
                        location.reload();
                    }else
                        alert("Không thành công:" + result);
                },
                error: function () {
                    alert('Có lỗi kết nối xảy ra');
                }
            });
        });
    });
</script>
</body>
</html>