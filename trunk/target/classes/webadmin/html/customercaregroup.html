<html>
<head>
    <title>Chuong trinh tra qua cham soc khach hang</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="/css/mask.css" rel="stylesheet" type="text/css"/>
    <link href="/css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="/js/jquery.1.9.js"></script>
    <script src="/js/session.js"></script>
    <script src="/js/cookie.js"></script>
    <script type="text/javascript" src="/js/mask.js"></script>
    <script src="/js/jquery-ui.js"></script>
    <link rel="stylesheet" href="/css/jquery-ui.css" type="text/css"/>

    <style type="text/css">
        table, th, td {
        border: none;
        }
    </style>
</head>
<body>
<div id="mydiv">

    <h2>Chuong trinh tra qua cham soc khach hang</h2>
    <div id="mydiv1">
        <table id="inputform">
            <tr>
                <td>Select file:</td>
                <td>
                    <form id="form" name="form">
                        <table>
                            <tr>
                                <td>
                                    <input type="file" id="file" name="file">
                                    <input type="hidden" id="hfile" name="hfile">
                                </td>
                            </tr>
                        </table>
                    </form>
                </td>

                <td>
                    <input style="width: 100px; font-size:16px; padding: 3px" type="button" value="Upload Data"
                           id="buttonTS"/>
                    <input style="width: 150px; font-size:16px; padding: 3px" type="button" value="Clear cache noti"
                           id="buttonCache"/>
                </td>

            </tr>
        </table>
    </div>
        <div id="responseDiv"></div>

        <table id="tbresult">

        </table>
</div>

<script type="text/javascript">

    function clearTable() {
        var head = "<tr>";
        head += "<th>Number</th>";
        head += "<th>Gift Type</th>";
        head += "<th>Time</th>"; //Cho phep tra thuong hay khong
        head += "<th>Gift Value</th>";   // Nhom tra thuong
        head += "<th>Duration</th>";
        head += "<th>Agent</th>";
        head += "<th>Error </th>";
        head += "<th>Error Description </th>";
        head +="</tr>";
        $("#tbresult").html(head);

    }

    function addItem(item) {

        var row;
        if(item.error !="" && item.error != "0"){
            row = "<tr style='color:red'>";
        }else{
            row = "<tr>";
        }
        row += "<td> " + item.number + " </td>";
        row += "<td> " + item.giftTypeId + " </td>";
        row += "<td> " + item.time + " </td>";
        row += "<td> " + item.giftValue + " </td>";
        row += "<td> " + item.duration + " </td>";
        row += "<td> " + item.agent + " </td>";
        row += "<td> " + item.error + " </td>";
        row += "<td> " + item.errorDesc + " </td>";
        row += "</tr>";

        $("#tbresult").append(row);
    }

    $(document).ready(function () {
        $('#buttonCache').click(function () {
            if ($.session.get("id") == null) {
                alert("Bạn phải đăng nhập.");
                $.session.clear();
                window.parent.location.href = "../html/login.html";
            }
            else {
                    var result = confirm("Bạn chắc chắn xóa hết dữ liệu để bắn noti cho các số trước không ????");
                    if (result == true) {
                        refreshData();
                    }
            }
        });

        $('#buttonTS').click(function () {
            if ($.session.get("id") == null) {
                alert("Bạn phải đăng nhập.");
                $.session.clear();
                window.parent.location.href = "../html/login.html";
            }
            else {

                if( ($("#hfile").val()==="") ){
                    alert("select a file to send out");
                    return;
                }

                if($("#hfile").val()!= ""){
                    var result = confirm("Bạn chắc chắn trả thưởng theo danh sách trong file: "+$("#hfile").val()+" ?");
                    if (result == true) {
                        send();
                    }
                }
            }
        });

        $("#file").change(function(){
            $("#hfile").val(this.value);
            var oData = new FormData(document.forms.namedItem("form"));
            $.ajax({
                type : "POST",
                url : "/uploadCustomerCareDollarHeartGroupFile",
                data : oData,
                processData : false,
                contentType : false,
                success : function(res) {
                    alert(res.desc);
                },
                error : function(xhr, ajaxOptions, thrownError) {
                    alert("Network error")
                }
            });
        });

    });

    function refreshData() {
        $('#mydiv').mask(" Đang refresh nha bồ, đừng bấm lung tung, không đấm phát chết luôn ... Xin cám ơn");
        $.ajax({
            url: "/refreshGlobalArrayResult",
            type: "GET",
            data: {
            },
            success: function (data) {
             $('#mydiv').unmask();
             if(data == "true")
             {
              alert('Xong rồi, hốt chích gì thì hốt đi');
             }
             else
             {
                alert('Khong clear duoc data');
             }
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    function sendabc() {
        $('#mydiv').mask("Đang trả thưởng, đừng tắt máy... Xin cám ơn");
        $.ajax({
            url: "/readCustomerCareDollarHeartGroupFile",
            type: "GET",
            data: {
                hFile:$("#hfile").val()
            },

            success: function (array) {
                if(array != null && array.length == 1)
                {
                    $('#mydiv').mask(array[0].percent);
                }
                else
                {
                    $('#mydiv').unmask();
                    if(array != null && array.length > 0){
                    clearTable();
                    for(i=0;i<array.length;i++){
                        addItem(array[i]);
                        }
                    }

                    $("#hfile").val("");
                }
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    function send() {

        $('#mydiv1').mask("Đang trả thưởng, đừng tắt máy... Xin cám ơn");
        $.ajax({
            url: "/readCustomerCareDollarHeartGroupFile",
            type: "GET",
            data: {
                hFile:$("#hfile").val()
            },

            success: function (array) {
                if(array != null && array.length > 0)
                {
                    checkGiftArray(array, 0, 10, array.length);
                }
            },
            error: function () {
                $('#mydiv1').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    function checkGiftArray(array, start, end, length)
    {
        if(end > length)
        {
            end = length
        }
        var tmp_array = [];
        for(i = start; i < end; i++)
        {
            tmp_array.push(array[i]);
        }
        sendGift(tmp_array, array, start, end, length);
    }

    function sendGift(tmp_array, main_array, start, end, length) {

        $('#mydiv1').mask("Đang chạy " + Math.round(start * 100/ length) + "%");
        var data_array = tmp_array;
        $.ajax({
            url: "/payDollarHeartGiftForCustomer",
            type: "POST",
            data: {
                arrjson:JSON.stringify(data_array)
            },
            processData : true,
            success: function (array) {
                if(end < length)
                {
                    checkGiftArray(main_array, end, end + 10, length)
                }
                else
                {
                    $('#mydiv1').unmask();
                    if(array != null && array.length > 0){
                    clearTable();
                    for(i=0;i<array.length;i++){
                        addItem(array[i]);
                        }
                    }
                    $("#hfile").val("");
                }
            },
            error: function () {
                $('#mydiv1').unmask();
                alert('Có lỗi kết nối 123 xảy ra');
            }
        });
    }


</script>
</body>
</html>
