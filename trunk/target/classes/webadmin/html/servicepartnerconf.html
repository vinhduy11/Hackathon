<html>
<head>
    <title>Service Partner Config Page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../css/mask.css" rel="stylesheet" type="text/css"/>
    <link href="../css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="../js/jquery.1.9.js"></script>
    <script src="../js/session.js"></script>
    <script src="../js/cookie.js"></script>
    <script src="../js/myjs.js"></script>
    <script type="text/javascript" src="../js/mask.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>

</head>
<body>
<div id="mydiv">
    <h2>Service Config Page</h2>
    <input type="button" value="Reload Cache" id="btnReload"></td>
    <div class="clear"></div>

    <div style="float:left">
        <b>App</b>:
        <select name="sAppType" id="sAppType" style="width: 150px; font-size:14px; padding: 3px">
            <option value="EU" selected>End User</option>
            <option value="DGD">DGD</option>
        </select>
        <b>Category</b>:
        <select name="sCateId" id="sCateId" style="width: 150px; font-size:14px; padding: 3px">
        </select>
        <b>Service Id</b> : <input type="text" style="border:1px solid #778899; width:150px" name="sServiceId"
                                   id="sServiceId">
        <input type="button" id="btnSearch" value="Search">
    </div>
    <h3></h3>
    <div class="clear"></div>
    <div id="table"></div>

    <div class="clear"></div>

    <div>
        <table>
            <tr>
                <th colspan="2">Edit Information</th>
            </tr>
            <tr>
                <td>App Type</td>
                <td>
                    <select id="appType" style="width: 150px; font-size:14px; padding: 3px">
                        <option value="EU">End User</option>
                        <option value="DGD">DGD</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Service ID</td>
                <td>
                    <input style="border: none" type="text" id="txtsId">
                    <input type="hidden" id="id_ser">
                </td>
            </tr>

            <tr>
                <td>Service Name</td>
                <td><input style="border: none" type="text" id="txtsName"></td>
            </tr>

            <tr>
                <td>Service Type</td>
                <td><input style="border: none" type="text" id="txtsType"></td>
            </tr>

            <tr>
                <td>Partner ID</td>
                <td><input style="border: none" type="text" id="txtpId"></td>
            </tr>
            <tr>
                <td>Partner Site</td>
                <td><input style="border: none" type="text" id="txtpSite"></td>
            </tr>

            <tr>
                <td>Text PopUp</td>
                <td><input style="border: none" type="text" id="txtPopUp"></td>
            </tr>
            <tr>
                <td>Has Check Debit</td>
                <td><input style="width: 20px; height: 20px" type="checkbox" id="txthCD"></td>
            </tr>
            <tr>
                <td>Status</td>
                <td>
                    <!--<input style="border: none" type="text" id ="txtstatus">-->
                    <select id="status" style="width: 150px; font-size:14px; padding: 3px">
                        <option value="0">Off</option>
                        <option value="1">On</option>
                        <option value="2">Future</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Is Active</td>
                <td>
                    <!--<input style="border: none" type="text" id ="txtstatus">-->
                    <select id="active" style="width: 150px; font-size:14px; padding: 3px">
                        <option value="0">Off</option>
                        <option value="1">On</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Status_Android</td>
                <td>
                    <!--<input style="border: none" type="text" id ="txtstatus">-->
                    <select id="status_android" style="width: 150px; font-size:14px; padding: 3px">
                        <option value="0">Off</option>
                        <option value="1">On</option>
                        <option value="2">Future</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Title dialog</td>
                <td><input style="border: none" type="text" id="txtTitleDialog"></td>
            </tr>

            <tr>
                <td>Bill Type</td>
                <td>
                    <!--<input style="border: none" type="text" id ="txtstatus">-->
                    <select id="billtype" style="width: 150px; font-size:14px; padding: 3px">
                        <option value="text">text</option>
                        <option value="phonenumber">phonenumber</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>BillerId</td>
                <td><input style="border: none" type="text" id="billerId"></td>
            </tr>

            <tr>
                <td>BillPay</td>
                <td><input style="border: none" type="text" id="billPay"></td>
            </tr>

            <tr>
                <td>Icon URL</td>
                <td>
                    <input style="border: none" type="text" id="txtiUrl">
                </td>
            </tr>

            <tr>
                <td>Icon Image</td>
                <td>
                    <img id="imgIcon">
                </td>
            </tr>

            <tr>
                <td>Is Promo</td>
                <td><input style="width: 20px; height: 20px" type="checkbox" id="chkIsPromo"></td>
            </tr>

            <tr>
                <td>Order</td>
                <td><input style="width: 100px; height: 20px" type="text" id="txtorder"></td>
            </tr>

            <tr>
                <td>Star</td>
                <td><input style="width: 20px; height: 20px" type="text" id="txtstar"></td>
            </tr>
            <tr>
                <td>Total form</td>

                <td>
                    <input style="width: 20px; height: 20px" type="text" id="txtnextform">
                </td>
            </tr>
            <tr>
                <td>Category</td>
                <td>
                    <select id="txtcate" name="txtcate" style="width: 150px; font-size:14px; padding: 3px">
                    </select>
                </td>
            </tr>

            <tr>
                <td>UAT</td>

                <td>
                    <input style="width: 20px; height: 20px" type="checkbox" id="chkUat">
                </td>
            </tr>

            <tr>
                <td>Web payment URL</td>

                <td>
                    <input style="border: none" type="text" id="txtWebPayment">
                </td>
            </tr>
            <tr>
                <td>Check Time</td>

                <td>
                    <input style="width: 20px; height: 20px" type="checkbox" id="chkTime">
                </td>
            </tr>

            <tr>
                <td>Duration To Pay/GroupDGD</td>
                <td><input style="width: 20px; height: 20px" type="text" id="txtDurationPay"></td>
            </tr>

            <tr>
                <td>Not load eu service</td>

                <td>
                    <input style="width: 20px; height: 20px" type="checkbox" id="chkLoadEUService">
                </td>
            </tr>

            <tr>
                <td></td>
                <td>
                    <input type="submit" value="Save" id="btSave" disabled/>
                    <input type="submit" value="Create" id="btNew">
                </td>
            </tr>

        </table>
    </div>

</div>

<script type="application/javascript">

    $(function () {

        $( document ).on( "click", "#edit", function(){

            $("#btSave").prop("disabled",false);

            //lay id cua dong duoc click
            var rid =$(this).attr("val");
            var id_ser = $(this).attr("id_ser");
            var rowId = "td[rid=" + rid + "]";

            //lay mang cac td tag
            var tdArr = $(rowId)

            //lay value tung td tag

            var serviceID = tdArr[1].innerHTML;
            var serviceName = tdArr[2].innerHTML;
            var serviceType = tdArr[3].innerHTML;
            var partnerID = tdArr[4].innerHTML;
            var partnerSite = tdArr[5].innerHTML;
            var iconUrl = tdArr[6].innerHTML;
            var textPopUp = tdArr[7].innerHTML;
            var hasCheckDebit = tdArr[8].firstChild.checked;
            var status = tdArr[9].innerHTML;

            var titleDialog = tdArr[10].innerHTML;

            var billType = tdArr[11].innerHTML;
            var billerId = tdArr[12].innerHTML;
            var billPay = tdArr[13].innerHTML;
            var isPromo = tdArr[14].innerHTML;

            var order = tdArr[15].innerHTML;
            var star = tdArr[16].innerHTML;
            var nextform = tdArr[17].innerHTML;
            var cateId = $(this).attr("catid");

            var isUat = tdArr[19].innerHTML;

            var webpaymenturl = tdArr[20].innerHTML;

            var check_time_on_one_bill = tdArr[21].innerHTML;

            var pay_time_on_one_bill = tdArr[22].innerHTML;

            var has_cached_bill = tdArr[23].innerHTML;

            var app_type = tdArr[0].innerHTML;

            var statusAndroid = tdArr[24].innerHTML;

            var active = tdArr[25].innerHTML;

            $("#id_ser").val(id_ser);
            $("#txtsId").val(serviceID);
            $("#txtsName").val(serviceName);
            $("#txtsType").val(serviceType);
            $("#txtpId").val(partnerID);
            $("#txtpSite").val(partnerSite);
            $("#txtiUrl").val(iconUrl);
            $("#imgIcon").attr('src', iconUrl);
            $("#txtPopUp").val(textPopUp);
            if (hasCheckDebit) {
                $("#txthCD").prop('checked', true);
            } else {
                $("#txthCD").prop('checked', false);
            }
            if (status == "Off")
                $("#status").val("0");
            else if (status == "On")
                $("#status").val("1");
            else
                $("#status").val("2");

            if (statusAndroid == "Off")
                $("#status_android").val("0");
            else if (statusAndroid == "On")
                $("#status_android").val("1");
            else
                $("#status_android").val("2");

            if (active == "Off")
                $("#active").val("0");
            else
                $("#active").val("1");
            //set title dialog
            $("#txtTitleDialog").val(titleDialog);

            $("#billtype").val(billType);
            $("#billerId").val(billerId);
            $("#billPay").val(billPay);
            if (isPromo === true || isPromo === "true") {
                $("#chkIsPromo").prop('checked', true);
            } else {
                $("#chkIsPromo").prop('checked', false);
            }

            if (isUat === true || isUat === "true") {
                $("#chkUat").prop('checked', true);
            } else {
                $("#chkUat").prop('checked', false);
            }

            $("#txtorder").val(order);
            $("#txtstar").val(star);
            $("#txtnextform").val(nextform);

            $("#txtcate").val(cateId);

            $("#txtWebPayment").val(webpaymenturl);

            if (check_time_on_one_bill === true || check_time_on_one_bill === "true") {
                $("#chkTime").prop('checked', true);
            } else {
                $("#chkTime").prop('checked', false);
            }

            $("#txtDurationPay").val(pay_time_on_one_bill);

            if (has_cached_bill === true || has_cached_bill === "true") {
                $("#chkLoadEUService").prop('checked', true);
            } else {
                $("#chkLoadEUService").prop('checked', false);
            }
            $('#appType').val(app_type);
            $("#txtsName").focus();
        });
    });

    $(function () {
        $(document).on("click", "#del", function () {
            var id_ser = $(this).attr("id_ser");
            var rid =$(this).attr("val");
            var rowId = "td[rid=" + rid + "]";
            var tdArr = $(rowId)
            var serviceID = tdArr[0].innerHTML;
            var result = confirm("Are you sure?");
                if (result == true){
                    $('#mydiv').mask("Loading...");
                    $.ajax({
                        url: "/service/del",
                        type: "GET",
                        data: {
                            _id : id_ser,
                            ser_id : serviceID,
                            id: $.session.get("id"),
                            username:$.session.get("username")
                        },
                        success: function (string) {
                            $('#mydiv').unmask();
                            var error = string["error"];
                            if (error == 0) {
                                alert("Thành công.");
                                init();
                            }
                            else if (error == -1) {
                                alert("Bạn phải đăng nhập.");
                                $.session.clear();
                                window.parent.location.href = "../html/login.html";
                            }
                            else
                                alert("Không thành công. Error code = " + error);
                        },
                        error: function () {
                            $('#mydiv').unmask();
                            alert('Có lỗi kết nối xảy ra');
                        }
                    });
                }
        });
    });

    $('#btSave').click(function () {
        var cateid = $("#sCateId").val();
        var serviceId = $("#sServiceId").val();
        upsert($("#id_ser").val(), cateid, serviceId);
    });

    $('#btNew').click(function () {
        $('#mydiv').mask("Loading...");
        $.ajax({
            url: "/service/checkser",
            type: "GET",
            data: {
                app_type: $("#appType").val(),
                ser_id : $("#txtsId").val(),
                id: $.session.get("id"),
                username:$.session.get("username")
            },
            success: function (string) {
                $('#mydiv').unmask();
                var error = string["error"];
                var desc = string["desc"];
                if (error == 0) {
                    upsert("");
                } else if (error == -1) {
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../html/login.html";
                } else if (error == 1) {
                    alert("Service ID đã tồn tại.");
                } else {
                    alert("Không thành công. Error code = " + error + ", Desc = " + desc);
                }
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    });

    function upsert(_id, cateid, serviceId){
        if ($.session.get("id")==null) {
            alert("Bạn phải đăng nhập.");
            $.session.clear();
            window.parent.location.href = "../html/login.html";
        } else {
            var appTypev = $("#appType").val();
            $('#mydiv').mask("Loading...");
            $.ajax({
                url: "/service/upsert",
                type: "GET",
                data: {
                    app_type: $("#appType").val(),
                    _id : _id,
                    ser_id : $("#txtsId").val(),
                    ser_name : $("#txtsName").val(),
                    ser_type : $("#txtsType").val(),
                    part_id : $("#txtpId").val(),
                    part_site : $("#txtpSite").val(),
                    icon_url : $("#txtiUrl").val(),
                    text_popup : $("#txtPopUp").val(),
                    has_ch_deb : $("#txthCD").is(":checked"),
                    status : $("#status").val(),
                    statusAndroid:$("#status_android").val(),
                    active:$("#active").val(),
                    id: $.session.get("id"),
                    username:$.session.get("username"),
                    title_dlog: $("#txtTitleDialog").val(),
                    bill_type: $("#billtype").val(),
                    billerid: $("#billerId").val(),
                    billpay: $("#billPay").val(),
                    is_promo : $("#chkIsPromo").is(":checked"),
                    ord:$("#txtorder").val(),
                    star:$("#txtstar").val(),
                    totfrm:$("#txtnextform").val(),
                    catname:$("#txtcate :selected").text(),
                    catid:$("#txtcate").val(),
                    uat :$("#chkUat").is(":checked"),
                    webpaymenturl :$("#txtWebPayment").val(),
                    check_time_on_one_bill :$("#chkTime").is(":checked"),
                    pay_time_on_one_bill :$("#txtDurationPay").val(),
                    has_cached_bill :$("#chkLoadEUService").is(":checked")
                },
                success: function (string) {
                    $('#mydiv').unmask();
                    var error = string["error"];
                    if (error == 0) {
                        alert("Thành công.");
                        $("#txtsId").val("");
                        $("#id_ser").val("");
                        $("#txtsName").val("");
                        $("#txtsType").val("");
                        $("#txtpId").val("");
                        $("#txtpSite").val("");
                        $("#txtiUrl").val("");
                        $("#imgIcon").attr('src', "");
                        $("#txtPopUp").val("");
                        $("#txthCD").prop('checked', false);
                        $("#status").val("0");
                        $("#active").val("0");
                        $("#status_android").val("0");
                        $("#txtTitleDialog").val("");
                        $("#billtype").val("");
                        $("#iconInput").val("");
                        $("#billerId").val("");
                        $("#billPay").val("");
                        $("#chkIsPromo").prop('checked', false);
                        $("#txtorder").val("");
                        $("#txtstar").val("");
                        $("#txtnextform").val("");
                        $("#txtcate").val("");
                        $("#txtWebPayment").val("");

                        $("#chkTime").prop('checked', false);
                        $("#txtDurationPay").val("");
                        $("#chkLoadEUService").prop('checked', false);

                        init(appTypev, cateid,serviceId);
                    }
                    else if (error == -1) {
                        alert("Bạn phải đăng nhập.");
                        $.session.clear();
                        window.parent.location.href = "../html/login.html";
                    }
                    else
                        alert("Không thành công. Error code = " + error);
                },
                error: function () {
                    $('#mydiv').unmask();
                    alert('Có lỗi kết nối xảy ra');
                }
            });
        }
    }

    $('#btnSearch').click(function () {
        var appType = $("#sAppType").val() != null ? $("#sAppType").val() : "EU";
        var cateid = $("#sCateId").val();
        var serviceId = $("#sServiceId").val();

        init(appType, cateid, serviceId);
    });

    $(document).ready(function () {
        var appType = $("#sAppType").val() != null ? $("#sAppType").val() : "EU";
        init(appType, "","");
        loadCategory();
    });

    function init(apptype, cateid, serviceId){
        $("#btSave").prop("disabled", true);
        $.ajax({
            url: "/service/getall",
            type: "GET",
            data: {
                apptype:apptype,
                cateid:cateid,
                serviceid:serviceId
            },
            success: function (string) {
                table = string["table"];
                $("#table").html(table);
            },
            error: function () {
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    function loadCategory(){
        var mUrl = "/service/getallcategory";
        $.getJSON(mUrl).done(function (data) {
            removeOpt("txtcate");
            removeOpt("sCateId");

            addOpt("txtcate","", "None");
            addOpt("sCateId","", "All");

            $.each(data, function (i, item) {
                addOpt("txtcate",item._id, item.name);
                addOpt("sCateId",item._id, item.name);
            });
        });
    }

    $('#btnReload').click(function () {
        reload();
    });
    function reload(){
        $.ajax({
            url: "/service/reload",
            type: "GET",
            success: function (string) {
                $('#mydiv').unmask();
                var error = string["error"];
                if (error == 0) {
                    alert("Thành công.");
                }
                else if (error == -1) {
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../html/login.html";
                }
                else
                    alert("Không thành công. Error code = " + error);
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

</script>
</body>
</html>