<!DOCTYPE html>
<html>
<head lang="en">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link rel="stylesheet" type="text/css" href="extjs/resources/css/ext-all-neptune.css"/>

    <script type="text/javascript" src="extjs/ext-all-debug.js"></script>
</head>
<body>
<script type="application/javascript">


    var chart, timeAxis;

    var generateData = (function() {
        var data = [], i = 0,
                last = false,
                date = new Date(2011, 1, 1),
                seconds = +date,
                min = Math.min,
                max = Math.max,
                random = Math.random;
        return function() {
            data = data.slice();
            data.push({
                date:  Ext.Date.add(date, Ext.Date.DAY, i++),
                visits: min(100, max(last? last.visits + (random() - 0.5) * 20 : random() * 100, 0)),
                views: min(100, max(last? last.views + (random() - 0.5) * 10 : random() * 100, 0)),
                veins: min(100, max(last? last.veins + (random() - 0.5) * 20 : random() * 100, 0))
            });
            last = data[data.length -1];
            return data;
        };
    })();

    var group = false,
            groupOp = [{
                dateFormat: 'M d',
                groupBy: 'year,month,day'
            }, {
                dateFormat: 'M',
                groupBy: 'year,month'
            }];

    function regroup() {
        group = !group;
        var axis = chart.axes.get(1),
                selectedGroup = groupOp[+group];
        axis.dateFormat = selectedGroup.dateFormat;
        axis.groupBy = selectedGroup.groupBy;

        chart.redraw();
    }

    var store = Ext.create('Ext.data.JsonStore', {
        fields: ['date', 'visits', 'views', 'veins'],
        data: generateData()
    });

    var intr = setInterval(function() {
        var gs = generateData();
        var toDate = timeAxis.toDate,
                lastDate = gs[gs.length - 1].date,
                markerIndex = chart.markerIndex || 0;
        if (+toDate < +lastDate) {
            markerIndex = 1;
            timeAxis.toDate = lastDate;
            timeAxis.fromDate = Ext.Date.add(Ext.Date.clone(timeAxis.fromDate), Ext.Date.DAY, 1);
            chart.markerIndex = markerIndex;
        }
        store.loadData(gs);
    }, 100);

    var mobileOnlineUserStatusPanel = Ext.create("Ext.panel.Panel", {
        margin: 5,
        width: "100%",
        title: "Mobile online users",
        layout: "fit",
        height: 400,
        items: [
            {
                xtype: 'chart',
                style: 'background:#fff',
                store: store,
                itemId: 'chartCmp',
                axes: [{
                    type: 'Numeric',
                    minimum: 0,
                    maximum: 500,
                    position: 'left',
                    fields: ['views', 'visits'],
                    title: 'Number of connections',
                    grid: {
                        odd: {
                            fill: '#dedede',
                            stroke: '#ddd',
                            'stroke-width': 0.5
                        }
                    }
                }, {
                    type: 'Time',
                    position: 'bottom',
                    fields: 'date',
                    title: 'Time',
                    dateFormat: 'M d',
                    groupBy: 'year,month,day,time',
                    aggregateOp: 'sum',

                    constrain: true,
                    fromDate: new Date(2011, 1, 1),
                    toDate: new Date(2011, 1, 7)
                }],
                series: [{
                    type: 'line',
                    axis: ['left', 'bottom'],
                    xField: 'date',
                    yField: 'visits',
                    label: {
                        display: 'none',
                        field: 'visits',
                        renderer: function(v) { return v >> 0; },
                        'text-anchor': 'middle'
                    },
                    markerConfig: {
                        radius: 5,
                        size: 5
                    }
                },{
                    type: 'line',
                    axis: ['left', 'bottom'],
                    xField: 'date',
                    yField: 'views',
                    label: {
                        display: 'none',
                        field: 'visits',
                        renderer: function(v) { return v >> 0; },
                        'text-anchor': 'middle'
                    },
                    markerConfig: {
                        radius: 5,
                        size: 5
                    }
                }]
            }
        ]
    });

    Ext.onReady(function () {
        Ext.create('Ext.Viewport', {
            layout: {
                type: "vbox"
            },

            items: [
                    mobileOnlineUserStatusPanel
            ]
        });
    });
</script>
</body>
</html>