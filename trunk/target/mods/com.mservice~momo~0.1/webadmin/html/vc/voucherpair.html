<!DOCTYPE html>
<html>
<head>
    <title>Voucher category</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="/css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="/js/jquery.1.9.js"></script>
    <script type="text/javascript" src="/js/mask.js"></script>
    <link rel="stylesheet" href="/css/jquery.datetimepicker.css" type="text/css"/>
    <script src="/js/jquery.datetimepicker.js"></script>
    <script src="/js/myjs.js"></script>

</head>
<body>
<div  class="container">
    <h2>Kiểm soát voucher</h2>
    <div class="clear"></div>
    <div>
        <table>
            <tr>
                <td>Nhập SĐT</td>
                <td>:</td>
                <td><input style="width: 150px; font-size:16px; padding: 3px" type="text" id="txtnumber"/></td>
                <td align="center"> <input style="padding: 3px" type="button" value="Tìm" id="btnFindNumber"></td>
            </tr>
        </table>
    </div>
    <div class="clear"></div>
    <div>
        <h3>Bảng Gift</h3>
        <table  id="owner">
        </table>
    </div>
    <div class="clear"></div>
    <div >
        <table>
            <tr>
                <td>ID:</td>
                <td><input type="text" readonly="true"  size="50"  id="txtId"/></td>
            </tr>
            <tr>
                <td>Amount:</td>
                <td><input type="text"  size="50" id="txtAmount"/></td>
            </tr>

            <tr>
            <tr>
                <td></td>
                <td>
                    <button id="btnClear">Clear</button>
                    <button id="btnSave">Save</button>
                </td>
            </tr>
        </table>
    </div>
    <div class="clear"></div>
    <div>
        <h3>Bảng QueuedGift</h3>
        <table id="used">
        </table>
    </div>
</div>

<script type="text/javascript">


    function clearTable() {
        var head = "<tr>";
        head += "<th>Edit</th>";
        head += "<th>Gift Type</th>";
        head += "<th>Amount</th>";
        head += "<th>Start Date</th>";
        head += "<th>End Date</th>";
        head += "<th>Modified Date</th>";
        head += "<th>Owner</th>";
        head += "<th>Status</th>";
        head += "<th>Locked</th>";
        head += "<th>Gift Id</th>";
        head +="</tr>";
        $("#owner").html(head);

        head = "";
        head = "<tr>";
        head += "<th>Delete</th>";
        head += "<th>Owner</th>";
        head += "<th>Services</th>";
        head += "<th>Gift Type</th>";
        head += "<th>Gift Id</th>";
        head +="</tr>";
        $("#used").html(head);
    }

    function addItemUsed(item) {
        var row;
        var deleteButton = "<button id='" + item._id + "'>Delete</button>";
        row = "<tr id='r_" + item._id + "'>";
        row += "<td> " + deleteButton + " </td>";
        row += "<td> " + item.owner + " </td>";
        row += "<td> " + item.service + " </td>";
        row += "<td> " + item.gifTypeId + " </td>";
        row += "<td> " + item.giftId + " </td>";
        row += "</tr>";

        $("#used").append(row);

        $("#" + item._id).click(function () {
        var number=this.id;

         var result = confirm("Are you sure?");
            if (result == true) {

            $('#mydiv').mask("Loading...");
            $.ajax({
                url: "/vc/deleteQueuedGift",
                type: "GET",
                data: {
                    "number":number
                },
                success: function (json) {

                    $('#mydiv').unmask();

                    var result ="";
                    if(json.desc !=null && json.desc != ""){
                        result += json.desc;
                    }

                    if(json.descsender != null && json.descsender != ""){
                        result += json.descsender;
                    }

                    $('#responseDiv').html(result);

                },
                error: function () {
                    $('#mydiv').unmask();
                    alert('Có lỗi kết nối xảy ra');
                }
            });
            loadPage();
    }

        });
    }

    function addItemOwner(item) {
        var row;
        var editButton = "<button val='"+item.amount+"' id='" + item._id + "'>Edit</button>";
        row = "<tr>";
        row += "<td> " + editButton + " </td>";
        row += "<td> " + item.typeId + " </td>";
        row += "<td> " + item.amount + " </td>";
        row += "<td> " + item.startDate + " </td>";
        row += "<td> " + item.endDate + " </td>";
        row += "<td> " + item.modifyDate + " </td>";
        row += "<td> " + item.owner + " </td>";
        row += "<td> " + item.status + " </td>";
        row += "<td> " + item.lock + " </td>";
        row += "<td> " + item._id + " </td>";
        row += "</tr>";

       $("#owner").append(row);

       $("#" + item._id).click(function () {
            $("#txtId").val($(this).attr("id"));
            $("#txtAmount").val($(this).attr("val").replace(",",""));
        });
    }
$("#btnClear").click(function(){
    $("#txtnumber").val("");
    $("#txtId").val("");
    $("#txtAmount").val("");
});
    $("#btnSave").click(function () {

            $.ajax({
                url: "/vc/updateOwner",
                type: "GET",
                enctype: "multipart/form-data",
                data: {
                    amount: $("#txtAmount").val(),
                     _id: $("#txtId").val()

                },
                success: function (result) {
                    var error = result.error;
                    if (error == 0) {
                        alert("Thành công.");
                        loadPage()
                    }
                    else
                        alert("amount: " + result.desc);
                },
                error: function () {
                    alert('Có lỗi kết nối xảy ra');
                }
            });
        });
    function loadPage() {

        var owner = $("#txtnumber").val();
        if(owner === ""){
            alert("Enter your phone number");
            $("#txtnumber").focus();
            return;
        }

        clearTable();
        var mUrlUsed = "/mLogger?number=" + owner;
        $.getJSON(mUrlUsed).done(function (data) {
            $.each(data, function (i, item) {
                addItemUsed(item);
            });
        });

        var mUrlOwner = "/vc/getOwner?number=" + owner;
        $.getJSON(mUrlOwner).done(function (data) {
            $.each(data, function (i, item) {
                addItemOwner(item);
            });
        });
    }

    $(document).ready(function () {
        $("#btnFindNumber").click(function(){
            loadPage();

        });

    });
</script>
</body>
</html>