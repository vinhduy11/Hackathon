<html>
<head>
    <title>Send Notification To Cloud Page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../css/mask.css" rel="stylesheet" type="text/css"/>
    <link href="../css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="../js/jquery.1.9.js"></script>
    <script src="../js/session.js"></script>
    <script src="../js/cookie.js"></script>
    <script type="text/javascript" src="../js/mask.js"></script>

    <style type="text/css">
        table, th, td {
        border: none;
        }
    </style>
</head>
<body>
<div id="mydiv" style="margin-left:5px;">

    <div style="padding-bottom:27px;">
        <div style="float:left; font-weight:bold;font-size:30px;color:red;">
            Send Notification To Cloud Page
        </div>
        <div id="child" style="float:right;">
            <span style="float: right; border:1px">
            Xin chào,
            <span id="username" style="color: #0000ff"></span>
            <button id="logout">Logout</button>
            </span>
        </div>
    </div>

    <div class="clear"></div>

    <table id="inputform">
        <tr>
            <td>Message caption:</td>
            <td><textarea style="width: 600px; font-size:16px; padding: 3px;" cols="150" rows="2"
                          id="caption"></textarea></td>
        </tr>
        <tr>
            <td>Notification type:</td>
            <td>
                <select id="notiType">
                    <option value="0"> [NOTI_DETAIL] > Màn hình chi tiết Noti</option>
                    <option value="1"> [NOTI_TRANSACTION] > Màn hình chi tiết LSGD</option>
                    <option value="2"> [NOTI_NEW_MOMOER] > Màn hình chi tiết Noti</option>
                    <option value="3"> [NOTI_ADVERTISE] > Màn hình chi tiết Noti</option>
                    <option value="4"> [NOTI_MONEY_REQUEST] > Popup confirm Đồng Ý Mượn tiền</option>
                    <option value="5"> [NOTI_UPDATE_INFO] > Màn hình cập nhật thông tin cá nhân</option>
                    <option value="6"> [NOTI_NOTICE] > Màn hình Thông báo</option>
                    <option value="7"> [NOTI_DEPOSIT_WITHDRAW_AT_PLACE] > Màn hình Nạp tiền tận nơi</option>
                    <!--<option value="8">	-NOTI_GENERIC    = 8, 	</option>-->
                    <option value="9"> [NOTI_STUDENT] > Màn hình Dịch Vụ > Giới thiệu bạn bè</option>
                    <option value="10"> [NOTI_123PHIM] > Mua ve xem phim,...</option>
                    <option value="11"> [NOTI_PAY_ONE_BILL] > Màn hình Thanh toán Hóa đơn</option>
                    <option value="12"> [NOTI_SERVICE_ONE_BILL] > Màn hình Thanh toán Dịch vụ</option>
                    <option value="13"> [NOTI_QR_CODE] > Màn hình QR Code</option>
                    <option value="14"> [NOTI_CASH_MONEY] > Màn hình NẠP tiền</option>
                    <option value="15"> [NOTI_WITHDRAW_MONEY] > Màn hình RÚT tiền</option>
                    <option value="16"> [NOTI_FIND_LOCATION] > Màn hình tìm điểm Giao dịch</option>
                    <!--<option value="17">	-NOTI_BORROW_MONEY = 17 -> Màn hình tìm MƯỢN TIÊN,...	</option>-->
                    <option value="18"> QUAN LY THE NGAN HANG</option>
                    <option value="19"> TAO THE VISA/MASTER</option>
                    <option value="20"> -NOTI_VOUCHER_VIEW = 20 -> Màn hình XEM VOUCHER,...</option>
                    <option value="21"> -NOTI_VOUCHER_CREATE = 21 -> Màn hình TẠO VOUCHER,.....</option>
                    <option value="22"> [NOTI_TOPUP] > Màn hinh Topup(nạp tiền điện thoại)</option>
                    <option value="23"> [NOTI_TRANSFER] > Màn hinh chuyển tiền</option>
                    <option value="28"> [NOTI_POPUP_INFORMATION]> Push Popup</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>
            </td>
            <td>
                <table id="inputformpopup" bgcolor="#faebd7" border="1">
                    <tr>
                        <td>Popup Type:</td>
                        <td>
                            <select id="popupType">
                                <option value="0">N0TI</option>
                                <option value="1">CONFIRM</option>
                                <option value="2">PAYMENT</option>
                                <option value="3">FILL_FORM</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Popup Button Title 1:</td>
                        <td>
                            <input type="text" id="popupButtonTitle1">
                        </td>
                    </tr>
                    <tr>
                        <td>Popup Button Title 2:</td>
                        <td>
                            <input type="text" id="popupButtonTitle2">
                        </td>
                    </tr>
                    <tr>
                        <td>Popup Button X:</td>
                        <td>
                            <input type="checkbox" id="popupButtonX">
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td>Service id:</td>
            <td>
                <select id="serviceId">
                </select>
            </td>
        </tr>
        <tr>
            <td>Category:</td>
            <td>
                <select id="category">
                    <option value="0">System</option>
                    <option value="1" selected>Advertisement</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Wallet by bank:</td>
            <td>
                <select id="bank">
                    <option value="" selected="selected">All</option>
                    <option value="12345">Vietcombank</option>
                    <option value="102">Viettinbank</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Button title:</td>
            <td><input id="txtButtonTitle" type="text" style="border: 1px solid #cccccc;"
                       placeholder="Leave empty to hide the noti button"/></td>
        </tr>
        <tr>
            <td>Button status:</td>
            <td>
                <select id="btnStatus">
                    <option value="0" selected> Hidden</option>
                    <option value="1"> Show notification's button in notification list</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Message body:</td>
            <td><textarea style="width: 600px; font-size:16px; padding: 3px;" cols="150" rows="7" id="body"></textarea>
            </td>
        </tr>
        <tr>
            <td>Message TEXT body for IOS:</td>
            <td><textarea maxlength="227" style="width: 600px; font-size:16px; padding: 3px" cols="150" rows="7"
                          id="bodyIOS"></textarea></td>
        </tr>
        <tr>
            <td>Message HTML body for IOS:</td>
            <td><textarea maxlength="227" style="width: 600px; font-size:16px; padding: 3px" cols="150" rows="7"
                          id="htmlBodyIOS"></textarea></td>
        </tr>
        <tr>
            <td id="counter" colspan="2" align="right"></td>
        </tr>
        <tr>
            <td>Phone number:</td>
            <td><textarea style="width: 600px; font-size:16px; padding: 3px" cols="150" rows="3" id="phone"
                          placeholder="Format: phone1;phone2;phone3 ... To send broadcast input: 9999"></textarea></td>
        </tr>
        <tr>
            <td>Url:</td>
            <td><textarea style="width: 600px; font-size:16px; padding: 3px" cols="150" rows="3" id="url"></textarea>
            </td>
        </tr>
        <tr>
            <td>Extra field:</td>
            <td><textarea maxlength="227" style="width: 600px; font-size:16px; padding: 3px" cols="150" rows="7"
                          id="extraField"></textarea></td>
        </tr>
        <tr>
            <td>Device type:</td>
            <td>
                <select id="dtype">
                    <option value="" selected="selected">All</option>
                    <option value="android">Android</option>
                    <option value="ios">iOS</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>Select file:</td>
            <td>
                <form id="form" name="form">
                    <table>
                        <tr>
                            <td>
                                <input type="file" id="file" name="file">
                                <input type="hidden" id="hfile" name="hfile">
                            </td>
                        </tr>
                    </table>
                </form>
            </td>
        </tr>
        <tr>
            <td colspan="2" align="center">
                <input style="width: 100px; font-size:16px; padding: 3px" type="button" value="Submit" id="buttonTS"/>
            </td>
        </tr>
    </table>
    <div id="responseDiv"></div>

</div>


<script type="text/javascript">
    $(document).ready(function () {

        var uname = $("#username").text($.session.get("username"));
        console.log(uname);
        $("#inputformpopup").hide();

        //ve trang login
        if(uname != null && uname == null || uname ===""){
            window.parent.location.href = "../html/login.html";
            return;
        }

        //hide div
        if(uname == "admin"){
            $("#child").hide();
        }

        $('#logout').click(function () {
            $.session.clear();
            window.parent.location.href = "../html/login.html";
        });

        $.getJSON("/service/getAvailableTranType").done(function (data) {

                var option = '<option value=""> None </option>';
                $("#serviceId").append(option);

            $.each(data, function (i, item) {
                var serviceId = item.tranTypeId;
                var serviceName = item.tranTypeName;
                var option = '<option value="' + serviceId + '">' + serviceName + '</option>';
                $("#serviceId").append(option);
            });
        });

        var characters = 227;
        $("#counter").html("You have <strong>" + characters + "</strong> characters remaining");
        $("#bodyIOS").keyup(function () {
            if (getsize($(this).val()) > characters) {
                var len = $(this).val().length;
                var temp = $(this).val();
                while (getsize(temp) > characters) {
                    len--;
                    temp = temp.substr(0, len);
                }
                $(this).val(temp);
            }
            var remaining = characters - getsize($(this).val());
            $("#counter").html("You have <strong>" + remaining + "</strong> characters remaining");
            if (remaining <= 10) {
                $("#counter").css("color", "red");
            }
            else {
                $("#counter").css("color", "black");
            }
        });

        $('#buttonTS').click(function () {
            if ($.session.get("id") == null) {
                alert("Bạn phải đăng nhập.");
                $.session.clear();
                window.parent.location.href = "../html/login.html";
            }
            else {
                if (getsize($("#bodyIOS").val()) > 227) {
                    alert("Nội dung tin nhắn cho IOS không được vượt quá 227 bytes");
                } else {

                    if(($("#phone").val() === "") &&  ($("#hfile").val()==="") ){
                        alert("Please enter phone number or select a file to send out");
                        return;
                    }

                    if($("#hfile").val()!= ""){
                        var result = confirm("Send notification to phones in file "+$("#hfile").val()+". Are you sure?");
                        if (result == true) {
                            send();
                        }
                    }else{
                        if ($("#phone").val() == "9999" || $("#phone").val() == "9999;"
                            || $("#phone").val() == "8888" || $("#phone").val() == "8888;" || $("#phone").val() == "7777" || $("#phone").val() == "7777;") {
                        var result = confirm("Send to all phone in the DB. Are you sure?");
                        if (result == true) {
                            send();
                        }
                        } else {
                            send();
                        }
                    }
                }
            }
        });

        $("#file").change(function(){
            $("#hfile").val(this.value);
            var oData = new FormData(document.forms.namedItem("form"));
            $.ajax({
                type : "POST",
                url : "/sendnoti/upload",
                data : oData,
                processData : false,
                contentType : false,
                success : function(res) {
                    alert(res.desc);
                },
                error : function(xhr, ajaxOptions, thrownError) {
                    alert("Network error")
                }
            });
        });

        $("#txtButtonTitle").keyup(function () {
            var v = $(this).val();
            console.log(v.length );
            if (v.length > 30) {
                $(this).css("backgroundColor", "#FF6600");
            } else {
                $(this).css("backgroundColor", "white");
            }
        });

        $("#notiType").change(function() {
            var val = this.value;
            if (28 != val) {
                $("#inputformpopup").hide();
            } else {
                $("#inputformpopup").show();
            }
        });
    });
    function getsize(string) {
        var utf8length = 0;
        for (var n = 0; n < string.length; n++) {
            var c = string.charCodeAt(n);
            if (c < 128) {
                utf8length++;
            }
            else if ((c > 127) && (c < 2048)) {
                utf8length = utf8length + 2;
            }
            else {
                utf8length = utf8length + 3;
            }
        }
        return utf8length;
    }
    function send() {
        $('#mydiv').mask("Loading...");
        $.ajax({
            url: "/sendnoti/cloud",
            type: "GET",
            data: {  phone: $("#phone").val(),
                body: $("#body").val(),
                caption: $("#caption").val(),
                bodyIOS: $("#bodyIOS").val(),
                extraField : $("#extraField").val(),
                htmlBodyIOS: $("#htmlBodyIOS").val(),

                id: $.session.get("id"),
                username: $.session.get("username"),
                notiType: $("#notiType").val(),
                btnTitle : $("#txtButtonTitle").val(),
                btnStatus : $("#btnStatus").val(),
                serviceId: $("#serviceId").val(),
                bank: $("#bank").val(),
                category: $("#category").val(),
                hfile:$("#hfile").val(),
                dtype:$("#dtype").val(),
                // popup info
                popupType: $("#popupType").val(),
                popupButtonTitle1: $("#popupButtonTitle1").val(),
                popupButtonTitle2: $("#popupButtonTitle2").val(),
                popupButtonX: $("#popupButtonX").is(":checked"),
                url:$("#url").val()
            },
            success: function (string) {
                $('#mydiv').unmask();

                var error = string.error;
                if (error == 0){
                    $("#hfile").val("");
                    alert(string.desc);
                }
                else if (error == -1) {
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../html/login.html";
                }
                else
                    alert("Không thành công. Error code = " + error + ". Description: " + string["desc"] + ".");

            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

</script>
</body>
</html>
