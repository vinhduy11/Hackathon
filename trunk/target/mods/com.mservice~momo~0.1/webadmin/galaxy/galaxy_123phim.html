
<html>
<head>
    <title>Momo Page</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="../css/mask.css" rel="stylesheet" type="text/css" />
    <link href="../css/mycss.css" rel="stylesheet" type="text/css"/>
    <script src="../js/jquery.1.9.js"></script>
    <script src="../js/session.js"></script>
    <script src="../js/cookie.js"></script>
    <script src="../js/mask.js"></script>
    <link rel="stylesheet" href="../css/jquery.datetimepicker.css" type="text/css"/>
    <script src="../js/jquery.datetimepicker.js"></script>
</head>
<body>
<div id="duinfo" style="height:50px">
    <span style="float: left; border:1px; font-weight:bold; font-size: 25px; padding-left:15px"> Kiểm tra thông tin Combo Galaxy </span>
    <span style="float: right; border:1px"> Xin chào, <span style="color: #0000ff" id="husername"></span> &nbsp;&nbsp;
    <button
            id="logout"> Logout
    </button> </span>
</div>
<div id="mydiv" style="padding-left: 16px;">
    <table>
        <tr>
            <td>Nhập mã Combo:</td>
            <td><input style="width: 150px; font-size:16px; padding: 3px" type="text" id="txtCode"/></td>
            <td align="center">
                <input style="padding: 3px; cursor:pointer;" type="button" value="Kiểm tra (Enter)" id="btnCheck" /> &nbsp;&nbsp;
                <input style="padding: 3px; cursor:pointer; font-weight: bold;" type="button" value="Trả Combo cứng" id="btnComplete"/> &nbsp;&nbsp;
                <input style="padding: 3px; cursor:pointer;" type="button" value="Combo không hợp lệ" id="btnInvalid"/>
            </td>
        </tr>
    </table>
    <br>
    <div id="responseDiv"></div>
    <br>
    <input type="hidden" id="id_code"/>

</div>
<hr>
<br>
<div id="mydiv2" style="padding-left: 16px;">
    <table>
        <tr>
            <td>Từ ngày:</td>
            <td><input style="width: 200px; font-size:16px; padding: 3px" type="text" id="txtFrom"/></td>
            <td>Đến ngày:</td>
            <td><input style="width: 200px; font-size:16px; padding: 3px" type="text" id="txtTo"/></td>
        </tr>
        <tr>
            <td align="center" colspan="4">
                <input style="padding: 3px; cursor:pointer;" type="button" value="Tổng hợp" id="btnReport" />
            </td>

        </tr>
    </table>
    <h3><a href="#" class="export">Tải về tại đây.</a></h3>
</div>


<script type="text/javascript">

    $(document).ready(function () {

        $("#husername").text($.session.get("username"));
        $("#username").val($.session.get("username"));
        $("#password").val($.session.get("password"));
        $("#txtCode").focus();
        $('#btnComplete').hide();
        $('#btnInvalid').hide();

        $(document).keydown(function(e) {

            //enter
            if(e.keyCode == 13){
                //enter
                get_Galaxy();
            }
        });

        $("#btnCheck").click(function(){
            get_Galaxy();
        });

        $("#btnComplete").click(function(){
            up_Galaxy("cmp");
        });

        $("#btnInvalid").click(function(){
            up_Galaxy("invalid");
        });

        $("#btnReport").click(function(){
            re_Galaxy();
        });

        $('#logout').click(function (){
            $.session.clear();
            window.parent.location.href = "../galaxy/login.html";
        });
    });

    function get_Galaxy(){

        $('#responseDiv').html("");
        $('#btnComplete').hide();
        $('#btnInvalid').hide();
        $('#id_code').val("");
        var code = $("#txtCode").val();
        if($("#txtCode").val() == ""){
            alert("Vui lòng nhập mã Combo cần kiểm tra");
            $("#txtCode").focus();
            return;
        }
        if($("#txtCode").val().length < 5){
            alert("Combo cần kiểm tra không hợp lệ.");
            $("#txtCode").focus();
            return;
        }
        $('#mydiv').mask("Loading...");
        $.ajax({
            url: "/phim123/getGalaxy",
            type: "GET",
            data: {
                "promo_code":$("#txtCode").val(),
                "password": $.session.get("password"),
                "username":$.session.get("username")
            },
            success: function (json){

                $('#mydiv').unmask();
                var error = json["error"];
                if(error==-1){
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../galaxy/login.html";
                    return;
                }

                if(error==-2){
                    alert(json.desc);
                    return;
                }

                var result ="<table>";
                if(json.code!=''){
                    result += "<tr><th style='width: 170px'>Số điện thoại </th><td style='width: 298px'><b>0" + json._id + "</b></td></tr>";
                    result += "<tr><th>Combo </th><td><b>" + json.code + "</b></td></tr>";
                    result += "<tr><th>Trạng thái </th><td><b style='color:red'>" + json.desc + "</b></td></tr>";
                    result += "<tr><th>Thời gian chiếu </th><td><b style='color:red'>" + json.dispaytime + "</b></td></tr>";
                    result += "<tr><th>Rạp chi nhánh</th><td><b style='color:red'>" + json.subrap + "</b></td></tr>";
                    result += "<tr><th>Ticket </th><td><b style='color:red'>" + json.tkcode + "</b></td></tr>";
                    result += "<tr><th>Số hóa đơn </th><td><b>" + json.invno + "</b></td></tr>";
                    result += "<tr><th>Tên phim </th><td><b>" + json.fname + "</b></td></tr>";
                    result += "<tr><th>Rạp </th><td><b>" + json.rap + "</b></td></tr>";
                    result += "<tr><th>Số ghế </th><td><b>" + json.seatlst + "</b></td></tr>";
                    result += "<tr><th>Thời gian mua vé</th><td><b>" + json.buytime + "</b></td></tr>";
                    result += "<tr><th>Tổng tiền vé</th><td><b>" + json.amount + "&nbsp;VND</b></td></tr>";

                    if(json.stat != 'new'){
                        result += "<tr><th>Người trả combo</th><td><b>" + json.uby + "</b></td></tr>";
                        result += "<tr><th>Thời gian cập nhật </th><td><b>" + json.update_time + "</b></td></tr>";
                    }else{
                        $('#btnComplete').show();
                        $('#btnInvalid').show();
                        $('#id_code').val(json._id);
                    }
                }else{
                    result += "<tr><th style='width: 170px'>Lỗi </th><td style='width: 298px'><b>Không tìm thấy Combo này.</b></td></tr>";
                }
                result += "</table>";

                $('#txtCode').focus();
                $('#responseDiv').html(result);

            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    function up_Galaxy(status){

        $('#mydiv').mask("Loading...");
        $.ajax({
            url: "/phim123/upGalaxy",
            type: "GET",
            data: {
                "id_code":$("#id_code").val(),
                "id_status":status,
                "password": $.session.get("password"),
                "username":$.session.get("username")
            },
            success: function (string) {
                $('#mydiv').unmask();
                var error = string["error"];
                if(error==0){
                    get_Galaxy();
                    $("#txtCode").val("");
                    $("#txtCode").focus();
                    $('#btnCmpolete').hide();
                    $('#btnInvalid').hide();
                }else if(error==-1){
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../galaxy/login.html";
                    return;
                }else{
                    alert("Không thành công. Error code = " + error);
                }
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }

    $("#txtFrom").datetimepicker({
        format: 'd/m/Y, H:i:s'
    });
    $("#txtTo").datetimepicker({
        format: 'd/m/Y, H:i:s'
    });

    $(".export").hide();

    function re_Galaxy(){

        $(".export").hide();
        if($("#txtFrom").val()=="" || $("#txtTo").val()==""){
            alert("Vui lòng chọn từ ngày, đến ngày.");
            return;
        }
        $.ajax({
            url: "/phim123/report",
            type: "GET",
            data: {
                "fromdate":$("#txtFrom").val(),
                "todate":$("#txtTo").val(),
                "password": $.session.get("password"),
                "username":$.session.get("username")
            },
            success: function (json) {
                var error = json["error"];
                if(error==-1){
                    alert("Bạn phải đăng nhập.");
                    $.session.clear();
                    window.parent.location.href = "../galaxy/login.html";
                    return;
                }
                var data = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(json["desc"]);
                $(".export")
                    .attr({
                    'download': 'Export_Combo.xls',
                    'href': data,
                    'target': '_blank'
                });
                $(".export").show();
            },
            error: function () {
                $('#mydiv').unmask();
                alert('Có lỗi kết nối xảy ra');
            }
        });
    }



</script>
</body>
</html>